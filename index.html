<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>MCQ Notes Driller</title>
  <style>
    :root{
      --bg:#0b0f14; --card:#121823; --muted:#8aa0b3; --text:#e7eef6; --accent:#68b2ff; --good:#37d399; --bad:#ff6b6b;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial;
      background:linear-gradient(180deg,#0a0e13,#0b1219 40%, #0a0e13); color:var(--text);
      display:flex; align-items:center; justify-content:center; padding:24px;
    }
    .app{width:min(1100px,100%);} 
    .card{background:var(--card); border:1px solid rgba(255,255,255,.08); border-radius:18px; box-shadow:0 10px 30px rgba(0,0,0,.25); overflow:hidden}
    header{display:flex; gap:12px; align-items:center; justify-content:space-between; padding:16px 20px; border-bottom:1px solid rgba(255,255,255,.06)}
    header h1{font-size:18px; margin:0; letter-spacing:.2px}
    header .meta{display:flex; gap:14px; align-items:center; color:var(--muted); font-size:13px}
    header .pill{background:rgba(255,255,255,.06); padding:6px 10px; border-radius:999px}

    /* Tabs */
    .tabs{display:flex; gap:8px; align-items:center}
    .tab{background:transparent; color:var(--muted); border:1px solid rgba(255,255,255,.08); padding:8px 12px; border-radius:10px; cursor:pointer; font-weight:700}
    .tab.active{background:var(--accent); color:#08121b; border-color:transparent}
    .ghost{background:transparent; color:var(--muted)}
    .soft{background:rgba(255,255,255,.08); color:var(--text)}
    .primary{background:var(--accent); color:#08121b}
    .danger{background:var(--bad); color:#120808}
    .ok{background:var(--good); color:#08120d}
    .disabled{opacity:.6; cursor:not-allowed}
    button{appearance:none; border:0; padding:10px 14px; border-radius:12px; font-weight:600; cursor:pointer; transition:.15s transform,.15s background,.15s opacity}
    button:active{transform:translateY(1px)}

    /* Views */
    .view{display:none; padding:20px}
    .view.active{display:block}
    .panel{border:1px solid rgba(255,255,255,.06); border-radius:14px; padding:16px}
    .panel h2{font-size:16px; margin:0 0 10px 0; color:#cfe6ff}
    .muted{color:var(--muted)}
    .small{font-size:12px}
    .kbd{font-family:ui-monospace,Consolas,monospace; background:#0d1420; border:1px solid rgba(255,255,255,.1); padding:2px 6px; border-radius:6px}
    .row{display:flex; gap:10px; flex-wrap:wrap; margin-top:10px}

    textarea{width:100%; min-height:260px; resize:vertical; background:#0e141d; color:var(--text); border:1px solid rgba(255,255,255,.08); border-radius:12px; padding:12px; font-family:ui-monospace,Consolas,monospace}

    /* Drill Layout */
    .quizWrap{max-width:900px; margin:0 auto}
    .question{font-size:20px; line-height:1.4; margin-bottom:14px}
    .options{display:grid; gap:10px}
    .opt{background:#101722; border:1px solid rgba(255,255,255,.08); padding:12px 14px; border-radius:12px; text-align:left; font-weight:600; color:white; outline:0}
    .opt.correct{border-color:rgba(55,211,153,.8); box-shadow:0 0 0 2px rgba(55,211,153,.25) inset}
    .opt.wrong{border-color:rgba(255,107,107,.8); box-shadow:0 0 0 2px rgba(255,107,107,.25) inset}
    .opt.hovered{outline:2px dashed rgba(184,241,255,.9); outline-offset:2px}
    .notes{margin-top:14px; background:#0e141d; border:1px solid rgba(255,255,255,.06); border-radius:12px; padding:12px; color:#c9d7e5; white-space:pre-wrap}
    .footer{display:flex; justify-content:space-between; align-items:center; margin-top:14px}
    .progress{height:10px; background:#0f1722; border:1px solid rgba(255,255,255,.06); border-radius:999px; overflow:hidden}
    .bar{height:100%; background:linear-gradient(90deg,#68b2ff,#b8f1ff)}
    .center{display:flex; align-items:center; justify-content:center}
    .hidden{display:none !important}

    .inline{display:inline-flex; gap:8px; align-items:center}
    input[type="number"]{background:#0e141d; color:var(--text); border:1px solid rgba(255,255,255,.08); border-radius:10px; padding:6px 8px; width:80px}
    .help{font-size:12px; color:var(--muted); margin-top:6px}
  </style>
</head>
<body>
  <div class="app card">
    <header>
      <h1>MCQ Notes Driller</h1>
      <div class="tabs">
        <button id="tab-import" class="tab active" title="Go to Import (I)">Import</button>
        <button id="tab-drill" class="tab" title="Go to Drill (D)">Drill</button>
      </div>
      <div class="meta">
        <span class="pill" id="progressPill">0 / 0</span>
        <span class="pill">Wrong: <span id="wrongCount">0</span> / <span id="wrongLimitLabel">2</span></span>
        <label class="pill" style="display:flex;gap:6px;align-items:center">
          <span class="small muted">Set</span>
          <select id="setSelect" style="background:#0e141d;color:var(--text);border:1px solid rgba(255,255,255,.12);border-radius:8px;padding:4px 6px">
            <option value="" disabled selected>Loading‚Ä¶</option>
          </select>
        </label>
        <button class="soft" id="resetBtn" title="Restart the current set (R)">Restart</button>
      </div>
    </header>

    <!-- IMPORT VIEW -->
    <section id="view-import" class="view active">
      <div class="panel">
        <h2>1) Paste your generated questions (JSON)</h2>
        <p class="muted small">Schema per item: { "id": "unique", "stem": "question text", "options": ["A","B","C","D"], "answer": 0, "notes": "your source notes here" }</p>
        <textarea id="inputArea" placeholder='[
  {
    "id": "ex-1",
    "stem": "Which vitamin deficiency causes night blindness?",
    "options": ["Vitamin A","Vitamin B12","Vitamin C","Vitamin K"],
    "answer": 0,
    "notes": "Vitamin A (retinol) is critical for rhodopsin in rods. Deficiency ‚Üí nyctalopia."
  }
]'></textarea>
        <div class="row">
          <button class="primary" id="loadBtn">Load Questions</button>
          <button class="soft" id="demoBtn">Load Demo Set</button>
          <button class="ghost" id="downloadTemplateBtn">Download JSON Template</button>
          <button class="ok" id="goDrillBtn" title="Go to Drill (D)">Go to Drill</button>
        </div>
        <div class="help">Set your fail threshold (auto‚Äërestart when wrong ‚â• limit):
          <div class="inline" style="margin-top:8px">
            <label for="wrongLimitInput" class="small muted">Wrong limit</label>
            <input id="wrongLimitInput" type="number" min="1" max="50" step="1" />
            <button id="saveWrongLimitBtn" class="soft small">Save</button>
            <span id="saveHint" class="small muted"></span>
          </div>
        </div>
        <p class="muted small" style="margin-top:8px">
          Tips: Paste JSON from ChatGPT ‚Üí <span class="kbd">Load Questions</span>. Options must be exactly 4.
          <b>If wrong answers reach your limit, the set auto‚Äërestarts.</b>
        </p>
        <div class="panel" style="margin-top:12px">
          <h2>üéÆ Controller / Keyboard quick map</h2>
          <div class="small muted">
            Keyboard: <span class="kbd">1</span>‚Äì<span class="kbd">4</span> choose ¬∑ <span class="kbd">‚Üê/‚Üí</span> Prev/Next ¬∑ <span class="kbd">R</span> Restart ¬∑ <span class="kbd">I</span>/<span class="kbd">D</span> switch views
            <br/>Gamepad (Nintendo/standard): D‚Äëpad ‚Üë/‚Üì move selection ¬∑ <b>A</b> choose ¬∑ <b>B</b>/Start Next ¬∑ <b>X</b>/L Prev ¬∑ <b>R</b> Next ¬∑ <b>Select</b> Restart ¬∑ <b>Plus</b> Drill ¬∑ <b>Minus</b> Import
          </div>
        </div>
      </div>
    </section>

    <section class="view" style="padding-top:0">
      <div class="panel">
        <h2>üìÅ Available Question Sets (auto‚Äëloaded from <span class="kbd">/questions/index.json</span>)</h2>
        <div id="setsList" class="small muted">Looking for sets‚Ä¶</div>
      </div>
    </section>

    <!-- DRILL VIEW -->
    <section id="view-drill" class="view">
      <div class="quizWrap">
        <div class="panel">
          <h2>2) Drill</h2>
          <div id="quizBox" class="hidden">
            <div class="question" id="stem"></div>
            <div class="options" id="options"></div>
            <div class="notes hidden" id="notes"></div>
            <div class="footer">
              <div style="flex:1; margin-right:12px">
                <div class="progress"><div class="bar" id="bar" style="width:0%"></div></div>
                <div class="small muted" id="statusText" style="margin-top:6px"></div>
              </div>
              <div class="row">
                <button class="soft" id="prevBtn" disabled>Prev</button>
                <button class="ok disabled" id="nextBtn">Next</button>
              </div>
            </div>
          </div>
          <div id="emptyState" class="center" style="min-height:200px">
            <div class="muted">No questions loaded yet. Go to <span class="kbd">Import</span> to load a set.</div>
          </div>
        </div>
      </div>
    </section>
  </div>

  <script>
  // --- State ---
  let QUESTIONS = [];
  let order = [];
  let idx = 0;              // index into order
  let answered = new Map();  // id -> {chosen, correct}
  let wrong = 0;
  let maxWrong = 2;          // configurable limit
  let hoverIndex = 0;        // controller/keyboard selection cursor (0..3)

  // persist wrong limit
  const LS_KEY = 'mcq_wrong_limit_v1';
  const savedLimit = parseInt(localStorage.getItem(LS_KEY), 10);
  if(!Number.isNaN(savedLimit) && savedLimit > 0){ maxWrong = savedLimit; }

  // --- Elements ---
  const els = {
    // tabs/views
    tabImport: document.getElementById('tab-import'),
    tabDrill: document.getElementById('tab-drill'),
    viewImport: document.getElementById('view-import'),
    viewDrill: document.getElementById('view-drill'),
    goDrillBtn: document.getElementById('goDrillBtn'),

    // import
    inputArea: document.getElementById('inputArea'),
    loadBtn: document.getElementById('loadBtn'),
    demoBtn: document.getElementById('demoBtn'),
    downloadTemplateBtn: document.getElementById('downloadTemplateBtn'),
    wrongLimitInput: document.getElementById('wrongLimitInput'),
    wrongLimitLabel: document.getElementById('wrongLimitLabel'),
    saveWrongLimitBtn: document.getElementById('saveWrongLimitBtn'),
    saveHint: document.getElementById('saveHint'),

    // sets
    setSelect: document.getElementById('setSelect'),
    setsList: document.getElementById('setsList'),

    // drill
    quizBox: document.getElementById('quizBox'),
    emptyState: document.getElementById('emptyState'),
    stem: document.getElementById('stem'),
    options: document.getElementById('options'),
    notes: document.getElementById('notes'),
    nextBtn: document.getElementById('nextBtn'),
    prevBtn: document.getElementById('prevBtn'),
    progressPill: document.getElementById('progressPill'),
    wrongCount: document.getElementById('wrongCount'),
    bar: document.getElementById('bar'),
    statusText: document.getElementById('statusText'),
    resetBtn: document.getElementById('resetBtn'),
  };

  // initialize wrong limit UI
  els.wrongLimitInput.value = maxWrong;
  els.wrongLimitLabel.textContent = maxWrong;

  // --- View helpers ---
  function setActiveView(name){
    const isImport = name === 'import';
    els.viewImport.classList.toggle('active', isImport);
    els.viewDrill.classList.toggle('active', !isImport);
    els.tabImport.classList.toggle('active', isImport);
    els.tabDrill.classList.toggle('active', !isImport);
  }

  // --- Utils ---
  // Auto-load all sets listed in /questions/index.json
  const SETS = new Map(); // key -> { title, file, items }

  async function fetchJSON(url){
    const resp = await fetch(url, { cache: 'no-store' });
    if(!resp.ok) throw new Error(`${url} ‚Üí HTTP ${resp.status}`);
    return await resp.json();
  }

  function normalizeSetPayload(payload, fallbackTitle){
    // Accept either {title, questions:[...]} or {title, items:[...]} or array
    if(Array.isArray(payload)){
      return { title: fallbackTitle, items: payload };
    }
    const title = payload.title || fallbackTitle || 'Untitled';
    const items = payload.questions || payload.items || payload.data || payload.qs || payload;
    return { title, items };
  }

  async function loadIndex(){
    try{
      const idx = await fetchJSON('questions/index.json');
      let entries = [];
      if(Array.isArray(idx)){
        if(idx.length && typeof idx[0] === 'string'){
          entries = idx.map(f=>({ file: String(f), title: null }));
        } else {
          entries = idx.map(o=>({ file: o.file || o.path || o.url || '', title: o.title || null })).filter(e=>e.file);
        }
      } else if(idx && idx.files){
        entries = idx.files.map(f=> typeof f === 'string' ? ({file:f, title:null}) : ({file:f.file, title:f.title||null}));
      }
      if(!entries.length) throw new Error('index.json has no entries');

      // populate selector and list
      els.setSelect.innerHTML = '';
      els.setsList.innerHTML = '';
      for(const entry of entries){
        const file = entry.file.startsWith('questions/') ? entry.file : `questions/${entry.file}`;
        try{
          const payload = await fetchJSON(file);
          const base = file.split('/').pop().replace(/\.json$/i,'');
          const { title, items } = normalizeSetPayload(payload, entry.title || base);
          SETS.set(base, { title, file, items });

          // add to dropdown
          const opt = document.createElement('option');
          opt.value = base; opt.textContent = title;
          els.setSelect.appendChild(opt);

          // add to list view
          const row = document.createElement('div');
          row.innerHTML = `<b>${title}</b> <span class="muted">(${base}.json)</span>`;
          els.setsList.appendChild(row);
        } catch(err){
          console.error('Failed loading', file, err);
        }
      }

      // auto-select first set
      const firstKey = [...SETS.keys()][0];
      if(firstKey){ els.setSelect.value = firstKey; applySet(firstKey); }
      else { els.setSelect.innerHTML = '<option disabled selected>No sets found</option>'; els.setsList.textContent='No sets found.'; }
    } catch(err){
      console.error('Index load error', err);
      els.setSelect.innerHTML = '<option disabled selected>index.json missing</option>';
      els.setsList.textContent = 'Could not load /questions/index.json. Create one listing your JSON files.';
    }
  }

  function applySet(key){
    const set = SETS.get(key);
    if(!set){ return; }
    const text = JSON.stringify(set.items);
    loadQuestions(text); // reuse existing flow
  }
  function shuffle(a){ for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]]} return a; }

  function parseInput(text){
    try{
      const data = JSON.parse(text);
      if(!Array.isArray(data)) throw new Error('Top-level JSON must be an array');
      data.forEach((q, i)=>{
        if(typeof q.stem!== 'string') throw new Error(`Item ${i+1} missing "stem"`);
        if(!Array.isArray(q.options) || q.options.length!==4) throw new Error(`Item ${i+1} must have 4 options`);
        if(!('answer' in q)) throw new Error(`Item ${i+1} missing "answer" (0-3 or matching option text)`);
        if(typeof q.notes !== 'string') throw new Error(`Item ${i+1} missing "notes" (string)`);
        if(typeof q.answer === 'number'){
          if(q.answer<0 || q.answer>3) throw new Error(`Item ${i+1} answer index must be 0-3`);
        } else if(typeof q.answer === 'string'){
          const ai = q.options.findIndex(o=>o.trim().toLowerCase()===q.answer.trim().toLowerCase());
          if(ai<0) throw new Error(`Item ${i+1} answer text not found in options`);
          q.answer = ai;
        } else {
          throw new Error(`Item ${i+1} answer must be number or string`);
        }
        if(!q.id) q.id = `q-${i+1}`;
      });
      return data;
    }catch(e){
      alert('Import error: '+e.message);
      return null;
    }
  }

  function loadQuestions(jsonText){
    const data = parseInput(jsonText);
    if(!data) return;
    QUESTIONS = data.map(q=>({...q}));
    order = [...Array(QUESTIONS.length).keys()];
    shuffle(order);
    idx = 0; answered.clear(); wrong = 0; hoverIndex = 0;
    els.wrongCount.textContent = wrong;
    els.emptyState.classList.add('hidden');
    els.quizBox.classList.remove('hidden');
    render();
    setActiveView('drill');
  }

  function setNextBtnState(disabled){
    els.nextBtn.classList.toggle('disabled', disabled);
    els.nextBtn.disabled = disabled;
  }

  function render(){
    const current = QUESTIONS[order[idx]];
    const total = QUESTIONS.length;
    els.progressPill.textContent = `${idx+1} / ${total}`;
    els.bar.style.width = `${((idx)/total)*100}%`;
    els.statusText.textContent = `Question ${idx+1} of ${total}`;

    els.stem.textContent = current.stem;
    els.options.innerHTML = '';
    els.notes.classList.add('hidden');
    els.notes.textContent = '';

    const seen = answered.get(current.id);

    current.options.forEach((opt, i)=>{
      const b = document.createElement('button');
      b.className = 'opt'; b.textContent = opt; b.setAttribute('data-index', i);
      if(seen){
        b.classList.add(i===current.answer ? 'correct' : (i===seen.chosen ? 'wrong' : ''));
        b.disabled = true;
      } else {
        if(i === hoverIndex) b.classList.add('hovered');
      }
      b.addEventListener('click', ()=> choose(i));
      els.options.appendChild(b);
    });

    els.prevBtn.disabled = idx===0;
    setNextBtnState(!seen);

    if(seen){ showNotes(current); }
  }

  function showNotes(q){
    els.notes.classList.remove('hidden');
    els.notes.textContent = q.notes || '(No notes provided)';
  }

  function choose(i){
    const current = QUESTIONS[order[idx]];
    if(answered.has(current.id)) return; // already answered
    const correct = i===current.answer;
    answered.set(current.id,{chosen:i, correct});

    if(!correct){
      wrong += 1; els.wrongCount.textContent = wrong;
      if(wrong >= maxWrong){
        alert(`‚ùå You reached your wrong limit (${maxWrong}). Restarting the set.`);
        restart();
        return;
      }
    }

    // decorate buttons
    [...els.options.children].forEach((b, k)=>{
      b.disabled = true;
      b.classList.toggle('correct', k===current.answer);
      if(k===i && !correct) b.classList.add('wrong');
      b.classList.remove('hovered');
    });

    showNotes(current);
    setNextBtnState(false);
  }

  function next(){
    if(idx < order.length-1){
      idx += 1; hoverIndex = 0; render();
    } else {
      // finished
      els.bar.style.width = '100%';
      const total = QUESTIONS.length;
      const correctCount = [...answered.values()].filter(v=>v.correct).length;
      const passed = wrong < maxWrong; // pass if you did NOT hit the limit
      const msg = passed ? '‚úÖ Passed' : '‚ùå Failed';
      alert(`${msg}\nCorrect: ${correctCount}/${total}\nWrong: ${wrong}`);
      if(!passed){ restart(); } else {
        if(confirm('Run the set again (reshuffle)?')){ restart(true); }
      }
    }
  }

  function prev(){ if(idx>0){ idx -= 1; hoverIndex = 0; render(); } }

  function restart(reshuffle=false){
    idx = 0; answered.clear(); wrong = 0; hoverIndex = 0; els.wrongCount.textContent = wrong;
    if(reshuffle){ shuffle(order); }
    render();
  }

  // --- Events: Tabs / Nav ---
  // load sets index on boot
  window.addEventListener('DOMContentLoaded', loadIndex);

  // change set from dropdown
  els.setSelect && els.setSelect.addEventListener('change', (e)=> applySet(e.target.value));

  // (existing)
  els.tabImport.addEventListener('click', ()=> setActiveView('import'));
  els.tabDrill.addEventListener('click', ()=> setActiveView('drill'));
  els.goDrillBtn.addEventListener('click', ()=> setActiveView('drill'));

  // --- Events: Import ---
  els.loadBtn.addEventListener('click', ()=> loadQuestions(els.inputArea.value.trim()));
  els.demoBtn.addEventListener('click', ()=>{
    const demo = [
      {id:'d1', stem:'Beta-blockers ‚Üì what cardiac parameter at rest and exercise?', options:['Contractility','Preload','Afterload','Heart rate'], answer:3, notes:'Œ≤-blockers primarily lower HR (negative chronotropy) and contractility (negative inotropy). Clinically, HR reduction is the most reliable exam answer.'},
      {id:'d2', stem:'Which nerve is compressed in carpal tunnel syndrome?', options:['Ulnar','Radial','Median','Musculocutaneous'], answer:2, notes:'Median nerve compression under the flexor retinaculum. Thenar weakness, paresthesia of lateral 3¬Ω digits, positive Phalen/Tinel.'},
      {id:'d3', stem:'A newborn with delayed passage of meconium‚Äîmost likely diagnosis?', options:['Hirschsprung disease','Intussusception','Pyloric stenosis','Necrotizing enterocolitis'], answer:0, notes:'Failure of neural crest cell migration ‚Üí aganglionosis of distal colon. Explosive stool after DRE; transition zone on contrast enema; confirm with rectal suction biopsy.'},
      {id:'d4', stem:'What organism causes pneumonia with ‚Äúcurrant jelly‚Äù sputum in alcohol use disorder?', options:['Streptococcus pneumoniae','Klebsiella pneumoniae','Pseudomonas aeruginosa','Legionella pneumophila'], answer:1, notes:'Klebsiella ‚Üí aspiration risk, upper-lobe abscesses, thick mucoid sputum; capsule produces bulging fissure sign.'},
      {id:'d5', stem:'Best next step for suspected ectopic pregnancy with hemodynamic instability?', options:['Methotrexate','Expectant management','Serial Œ≤-hCG','Immediate surgical exploration'], answer:3, notes:'Unstable + suspected ectopic ‚Üí urgent laparoscopy/laparotomy. Methotrexate only for stable, unruptured cases.'}
    ];
    els.inputArea.value = JSON.stringify(demo, null, 2);
    loadQuestions(els.inputArea.value);
  });

  els.downloadTemplateBtn.addEventListener('click', ()=>{
    const tmpl = [
      {id:'unique-id-1', stem:'Your question here', options:['A','B','C','D'], answer:0, notes:'Paste the relevant notes/explanation here.'}
    ];
    const blob = new Blob([JSON.stringify(tmpl,null,2)], {type:'application/json'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'mcq_template.json';
    a.click();
  });

  // save wrong limit
  function saveLimit(){
    const v = parseInt(els.wrongLimitInput.value, 10);
    if(Number.isNaN(v) || v < 1){ els.saveHint.textContent = 'Enter a number ‚â• 1'; return; }
    maxWrong = v; localStorage.setItem(LS_KEY, String(v));
    els.wrongLimitLabel.textContent = maxWrong;
    els.saveHint.textContent = 'Saved!';
    setTimeout(()=> els.saveHint.textContent = '', 1200);
  }
  els.saveWrongLimitBtn.addEventListener('click', saveLimit);
  els.wrongLimitInput.addEventListener('keydown', (e)=>{ if(e.key==='Enter') saveLimit(); });

  // --- Events: Drill ---
  els.nextBtn.addEventListener('click', next);
  els.prevBtn.addEventListener('click', prev);
  els.resetBtn.addEventListener('click', ()=> restart(true));

  // --- Keyboard shortcuts ---
  document.addEventListener('keydown', (e)=>{
    const key = e.key.toLowerCase();
    if(key==='i') setActiveView('import');
    if(key==='d') setActiveView('drill');

    if(e.key==='ArrowRight' && !els.nextBtn.disabled) next();
    if(e.key==='ArrowLeft') prev();

    if(['1','2','3','4'].includes(e.key)){
      const n = parseInt(e.key,10)-1;
      const current = QUESTIONS[order[idx]];
      if(current && !answered.get(current.id)) choose(n);
    }

    if(e.key==='ArrowUp') moveHover(-1);
    if(e.key==='ArrowDown') moveHover(1);
    if(e.key==='enter'){
      const current = QUESTIONS[order[idx]];
      if(current && !answered.get(current.id)) choose(hoverIndex);
    }
    if(key==='r') restart(true);
  });

  function moveHover(delta){
    const current = QUESTIONS[order[idx]];
    if(!current) return; // nothing loaded
    if(answered.get(current.id)) return; // already answered, ignore
    hoverIndex = (hoverIndex + delta + 4) % 4;
    [...els.options.children].forEach((b, k)=>{
      b.classList.toggle('hovered', k === hoverIndex);
    });
  }

  // --- Gamepad support ---
  let gpRAF = null;
  let prevButtons = [];
  let axisCooldown = 0; // debounce stick/D-pad axes

  function startGamepadLoop(){
    if(gpRAF) return;
    const loop = (ts)=>{
      const pads = navigator.getGamepads ? navigator.getGamepads() : [];
      const gp = pads && pads[0]; // use first connected controller
      if(gp){
        handleGamepad(gp, ts);
      }
      gpRAF = requestAnimationFrame(loop);
    };
    gpRAF = requestAnimationFrame(loop);
  }

  function stopGamepadLoop(){ if(gpRAF){ cancelAnimationFrame(gpRAF); gpRAF = null; } }

  window.addEventListener('gamepadconnected', (e)=>{ startGamepadLoop(); console.log('Gamepad connected', e.gamepad); });
  window.addEventListener('gamepaddisconnected', (e)=>{ console.log('Gamepad disconnected', e.gamepad); if(!navigator.getGamepads().some(g=>g)) stopGamepadLoop(); });

  function pressedEdge(i, buttons){ return buttons[i] && buttons[i].pressed && !(prevButtons[i] && prevButtons[i].pressed); }

  function handleGamepad(gp, ts){
    const btn = gp.buttons;

    // Axes: use D-pad axes when exposed as axes (rare) or sticks for navigation
    // debounce axes to avoid rapid repeats
    axisCooldown = axisCooldown - 1;
    const axY = (gp.axes && gp.axes.length>1) ? gp.axes[1] : 0; // left stick vertical
    if(axisCooldown <= 0){
      if(axY < -0.5){ moveHover(-1); axisCooldown = 8; }
      else if(axY > 0.5){ moveHover(1); axisCooldown = 8; }
    }

    // D-pad buttons (standard mapping 12..15)
    if(pressedEdge(12, btn)) moveHover(-1); // up
    if(pressedEdge(13, btn)) moveHover(1);  // down

    // A (0) choose
    if(pressedEdge(0, btn)){
      const current = QUESTIONS[order[idx]];
      if(current && !answered.get(current.id)) choose(hoverIndex);
    }

    // B (1) or Start (9) -> Next
    if(pressedEdge(1, btn) || pressedEdge(9, btn)){
      if(!els.nextBtn.disabled) next();
    }

    // X (2) or L (4) -> Prev
    if(pressedEdge(2, btn) || pressedEdge(4, btn)) prev();

    // R (5) -> Next
    if(pressedEdge(5, btn)) if(!els.nextBtn.disabled) next();

    // Select/Minus (8) -> Restart
    if(pressedEdge(8, btn)) restart(true);

    // Plus (9) already mapped to Next; use Home (16) to toggle Drill
    if(btn[16] && pressedEdge(16, btn)) setActiveView('drill');

    // Capture (17) -> Import
    if(btn[17] && pressedEdge(17, btn)) setActiveView('import');

    prevButtons = btn.map(b=>({pressed:b.pressed}));
  }

  // kick off polling immediately (for browsers that don't fire gamepadconnected until a button is pressed)
  startGamepadLoop();

  </script>
</body>
</html>
